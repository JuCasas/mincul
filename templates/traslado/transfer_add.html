{% extends 'base/base.html' %}
{% load static %}
{% load get_email %}

{% block extrastyle %}
    <link href="{% static 'lib/flatpickr/flatpickr.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/datatables-1.10.20/css/jquery.dataTables.css' %}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.css" rel="stylesheet">

    <style>

        .jq-toast-wrap {
            width: 500px;
        }

        .close-icon {
            cursor: pointer;
        }

        table {
            min-width: 100%;
            color: #2B2D42 !important;
            background-color: #EDF2F9;
        }
    </style>
{% endblock %}

{% block body %}

    <div class="card">
        <div class="card-header">
            {% if operacion == "agregar" %}
                <h5>Nueva Solicitud de Traslado</h5>
            {% else %}
                <h5>Editar Traslado</h5>
            {% endif %}
        </div>

        <div class="card-body bg-light">
            {% if operacion == "agregar" %}
                <form name="formAgregar" id="formAgregar" action="{% url 'addTransfer' %}" method="POST"
                      enctype="multipart/form-data">
            {% else %}
                <form name="formAgregar" id="formAgregar" action="{% url 'edit_transfer' idEditar %}" method="POST"
                      enctype="multipart/form-data">
            {% endif %}
            {% csrf_token %}
            <div class="row">
                <div class="col-md-4 col-lg-4 col-sm-12">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>General</h5>
                        </div>
                        <div class="card-body bg-light">
                            <div class="form-group">
                                <label for="tipoTraslado">Tipo de Traslado:</label>
                                <select class="form-control" id="tipoTraslado" required
                                        {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                                    <option {% if traslado.tipoTraslado == '1' %} selected {% endif %}>Exposición en el
                                        extranjero
                                    </option>
                                    <option {% if traslado.tipoTraslado == '2' %} selected {% endif %}>Exponsición
                                        nacional
                                    </option>
                                    <option {% if traslado.tipoTraslado == '3' %} selected {% endif %}>Misión
                                        Diplomática
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pais">País destino:</label>
                                <select class="form-control selectpicker" id="pais" name="pais"
                                        data-placeholder='Seleccione pais...' required
                                        {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                                    {% include 'traslado/paises.html' %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ubigeo">Dirección de destino:</label>
                                <input class="form-control" id="destino" name="destino" type="text"
                                       value="{{ traslado.destino }}" required
                                       {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                            </div>

                            <div class="form-group ">
                                <label for="nombreExposicion">Nombre de la Exposición:</label>
                                <input class="form-control" id="nombreExposicion" name="nombreExposicion"
                                       type="text"
                                       value="{{ traslado.nombreExposicion }}" required
                                       {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                            </div>

                            <div class="form-group">
                                <label for="comisario">Comisario:</label>
                                <select class="form-control selectpicker" id="comisario" name="comisario"
                                        data-placeholder='Seleccione comisario...'
                                        {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                                    {% for c in comisarios %}
                                        <option value="{{ c.pk }}">{{ c.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            {% if traslado.estado == '2' %}
                                <div class="form-group">
                                    <label for="nResolucion">N° de Resolucion:</label>
                                    <input class="form-control" id="nResolucion" name="nResolucion" type="text"
                                           value="{{ traslado.numeroResolucion }}">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-8 col-lg-8 col-sm-12">
                    <div class="row">
                        <div class="col ">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Entidad solicitante</h5>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="form-group">
                                        <label for="nombreInstitucion">Entidad Solicitante</label>
                                        <select class="form-control selectpicker" id="nombreInstitucion"
                                                name="nombreInstitucion"
                                                data-placeholder='Seleccione entidad...' onchange="getEmail(this)"
                                                {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                                            {% for e in entidades %}
                                                <option value="{{ e.pk }}">{{ e.nombreSolicitante }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="form-group ">
                                        <label for="nombreExposicion">Correo de la entidad solicitante:</label>
                                        <input class="form-control" id="correoEntidadSolicitante"
                                               name="correoEntidadSolicitante"
                                               type="text"
                                               value="{{ traslado.entidadSolicitante.correo }}" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col ">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Fechas</h5>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fechaSalidaProgramada">Fecha Salida Programada: </label>
                                                <input class="form-control" id="fechaSalidaProgramada"
                                                       name="fechaSalidaProgramada" type="date"
                                                       value="{{ traslado.fechaSalidaProgramada|date:'Y-m-d' }}"
                                                       {% if traslado.estado != '1' and idEditar != 0 %}disabled{% endif %}>
                                            </div>

                                            {% if traslado.estado == '4' %}
                                                <div class="form-group">
                                                    <label for="fechaSalidaReal">Fecha de Salida Real:</label>
                                                    <input class="form-control" id="fechaSalidaReal"
                                                           name="fechaSalidaReal"
                                                           type="date"
                                                           value="{{ traslado.fechaSalidaReal|date:'Y-m-d' }}">
                                                </div>
                                            {% endif %}

                                            {% if traslado.estado == '5' %}
                                                <div class="form-group">
                                                    <label for="fechaRetornoReal">Fecha de Retorno:</label>
                                                    <input class="form-control" id="fechaRetornoReal"
                                                           name="fechaRetornoReal" type="date"
                                                           value="{{ traslado.fechaRetornoReal|date:'Y-m-d' }}">
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row mt-3">
                        <div class="col">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Patrimonios a ser trasladados</h5>
                                </div>
                                <div class="form-group col-auto d-flex align-items-end">
                                    <select class="form-control selectpicker" id="patrimonio" name="patrimonio"
                                            data-placeholder='Seleccione patrimonio...'
                                            {% if traslado.estado != '1' and idEditar != 0 %} hidden {% endif %} >
                                    </select>

                                    <button id="btnAgregarPatrimonio" class="btn btn-primary btn-sm ml-2"
                                            type="button"
                                            onclick="agregarPatrimonioTabla()"
                                            {% if traslado.estado != '1' and idEditar != 0 %}  hidden{% endif %}
                                    >Agregar
                                    </button>

                                </div>
                                <div class="card-body bg-light">
                                    <table class="table table-responsive-sm">
                                        <thead class="thead-dark">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Patrimonio</th>
                                            <th scope="col">Clasificación</th>
                                            <th scope="col">Tipo de bien</th>
                                            <th scope="col">Estado</th>
                                            <th scope="col">Acciones</th>
                                        </tr>
                                        </thead>
                                        <tbody id="patrimonioAgregar">
                                        {% for patrimonio in patrimonios %}
                                            <tr>
                                                <td>{{ patrimonio.pk }}</td>
                                                <td>{{ patrimonio.nombreTituloDemoninacion }}</td>
                                                <td>{{ patrimonio.categoria.nombre }}</td>
                                                <td>{{ patrimonio.get_tipoPatrimonio_display }}</td>
                                                <td>{{ patrimonio.get_estado_display }}</td>
                                                <td>
                                                    <button class="btn" href="#" type="button"
                                                            onclick="eliminarPatrimonio(this,{{ patrimonio.pk }})">
                                                        <i class="fas fa-trash" data-fa-transform="shrink-3"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card my-3" {% if traslado.estado != '1' and idEditar != 0 %}  hidden{% endif %}>
                <div class="card-header">
                    <h5>Documentos nuevos:</h5>
                </div>
                <div class="card-body bg-light">
                    <div class="dropzone dropzone-multiple p-0" data-dropzone
                         data-options='{"url":"valid/url"}'>
                        <div class="fallback">
                            <input type="file" name="file" multiple>
                        </div>
                        {% comment %}                             <div class="dz-message" data-dz-message><img class="mr-2"
                                                                                             src="{% static 'img/icons/cloud-upload.svg' %}"
                                                                                             width="25" alt="">Suelta tus archivos aquí
                                                </div>
                                                <div class="dz-preview dz-preview-multiple m-0 d-flex flex-column">
                                                    <div class="media align-items-center mb-3 pb-3 border-bottom btn-reveal-trigger">
                                                        <img
                                                                class="dz-image" src="..." alt="..." data-dz-thumbnail>
                                                        <div class="media-body d-flex flex-between-center">
                                                            <div>
                                                                <h6 data-dz-name></h6>
                                                                <div class="d-flex align-items-center">
                                                                    <p class="mb-0 fs--1 text-400 line-height-1" data-dz-size></p>
                                                                    <div class="dz-progress"><span class="dz-upload"
                                                                                                   data-dz-uploadprogress=""></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="dropdown text-sans-serif">
                                                                <button class="btn btn-link text-600 btn-sm dropdown-toggle btn-reveal dropdown-caret-none"
                                                                        type="button" data-toggle="dropdown" aria-haspopup="true"
                                                                        aria-expanded="false"><span class="fas fa-ellipsis-h"></span>
                                                                </button>
                                                                <div class="dropdown-menu dropdown-menu-right border py-0">
                                                                    <div class="bg-white py-2"><a class="dropdown-item" href="#!"
                                                                                                  data-dz-remove>Remove File </a></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>{% endcomment %}
                    </div>
                </div>
            </div>


            {% if operacion == "editar" %}
                <div class="card my-3">
                    <div class="card-header">
                        <h5>Documentos actuales:</h5>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            {% for documento in documentos %}
                                <div class="col-2">
                                    <div class="card mx-1">

                                        <div class="card-header p-2 d-flex justify-content-end">
                                            <button class="close float-none" type="button" aria-label="Close"
                                                    onclick="abrirModalEliminar(this,{{ documento.documento.pk }}, '{{ documento.documento.filename }}')">
                                                <span aria-hidden="true">×</span>
                                            </button>
                                        </div>

                                        <a class="notification notification-flush bg-0 "
                                           href="{{ media_path }}{{ documento.documento.url }}" download>
                                            <div class="card-body p-0">
                                                <div>
                                                    <img class="img-fluid" src="{% static 'img/icons/icono-PDF.png' %}">
                                                </div>
                                            </div>
                                            <div class="card-footer p-2">
                                                <h6>{{ documento.documento.filename }}</h6>
                                            </div>
                                        </a>

                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            <input id="lista" name="lista" type="hidden">


            <div class="row">
                <div class="col-8">
                    <div class="row mt-5">
                        <div class="col-11">
                            <div class="row mx-3">
                                <div class="col-2 flex-center mt-auto mb-auto ">
                                    <h5 class="flex-center mt-auto mb-auto">Estado: </h5>
                                </div>
                                <div class="col-3">
                                <span class="btn
                                {% if traslado.estado == '1' %}
                                    btn-warning
                                {% elif traslado.estado == '2' %}
                                    btn-info
                                {% elif traslado.estado == '3' %}
                                    btn-danger
                                {% elif traslado.estado == '4' %}
                                    btn-success
                                {% elif traslado.estado == '5' %}
                                    btn-dark
                                {% elif traslado.estado == '6' %}
                                    btn-light
                                {% endif %} ">
                                    {{ traslado.get_estado_display }}
                                </span>
                                </div>

                                {% if operacion == "editar" %}
                                    {% if traslado.estado == '1' or traslado.estado == '2' or traslado.estado == '4' or  traslado.estado == '5' %}
                                        <div class="col-3 p-0">
                                            <button class="btn btn-primary mx-1" type="button" data-toggle="modal"
                                                    data-target="#actualizarEstado">
                                                Actualizar estado
                                            </button>
                                        </div>
                                    {% endif %}

                                    {% if traslado.estado == '3' %}
                                        <div class="col-3 p-0">
                                            <button class="btn btn-primary mx-1" type="button" data-toggle="modal"
                                                    data-target="#verDetalleRechazo">
                                                Ver detalle de rechazo
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="d-flex flex-row justify-content-end mt-5">
                        <div class="flex-column">
                            <a class="btn btn-primary mr-3 mb-1" type="button"
                               href="{% url 'list_transfers' %}">Cancelar</a>
                        </div>
                        <div class="flex-column">
                            <button id="agr" class="btn btn-primary mr-3 mb-1" type="button">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modalFecha" tabindex="-1" role="dialog" aria-labelledby="modalFechaLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFechaLabel">Aviso</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span
                            class="font-weight-light" aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="formErrorFecha" name="formErrorFecha">
                        <div class="form-group">
                            ¡La fecha de fin debe ser mayor que la fecha inicio!
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="btnModalErrorFecha" class="btn btn-primary btn-sm" type="button" data-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNombreCodigo" tabindex="-1" role="dialog" aria-labelledby="modalNombreCodigoLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNombreCodigoLabel">Aviso</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span
                            class="font-weight-light" aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="formErrorNombreCodigo" name="formErrorNombreCodigo">
                        <div class="form-group">
                            ¡El número de resolución ya se encuentra registrado!
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="btnModalErrorFecha" class="btn btn-primary btn-sm" type="button" data-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalPatrimonios" tabindex="-1" role="dialog" aria-labelledby="modalPatrimoniosLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPatrimoniosLabel">Aviso</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span
                            class="font-weight-light" aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="formErrorModalPatrimonios" name="formErrorModalPatrimonios">
                        <div class="form-group">
                            ¡Debe seleccionar al menos un patrimonio!
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="btnModalErrorPatrimonio" class="btn btn-primary btn-sm" type="button"
                            data-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal-->
    <div class="modal fade" id="actualizarEstado" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Actualizar estado</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span
                            class="font-weight-light" aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">

                    {% if traslado.estado == '1' %}
                        <p>
                            A continuación se procederá a actualizar el estado de la solicitud a "EVALUAR".
                            ¿Esta seguro que desea confirmar esta acción?
                        </p>
                    {% endif %}

                    {% if traslado.estado == '2' %}
                        <form id="formularioActualizarEstado">
                            <div class="form-group">
                                <label for="estadoSolicitud">Estado: </label>
                                <select class="form-control selectpicker" id="estadoSolicitud" name="estadoSolicitud"
                                        onchange="validar_campo_detalle()">

                                    {% if traslado.estado == '1' %}
                                        <option disabled selected> Seleccione una acción</option>
                                    {% endif %}

                                    {% for estado in estadosEditables %}
                                        <option data="{{ estado.0 }}" value={{ estado.0 }}
                                                {% if traslado.estado == estado.0 %} selected {% endif %}>{{ estado.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group" id="inputDetalle">
                                <label for="detalleRechazo">Detalle:</label>
                                <textarea class="form-control" id="detalleRechazo" name="detalleRechazo"
                                          rows="3" required></textarea>
                            </div>
                        </form>
                    {% endif %}

                    {% if traslado.estado == '4' %}
                        <p>
                            A continuación se procederá a actualizar el estado de la solicitud a "EJECUTAR".
                            ¿Esta seguro que desea confirmar esta acción?
                        </p>
                    {% endif %}

                    {% if traslado.estado == '5' %}
                        <p>
                            A continuación se procederá a actualizar el estado de la solicitud a "FINALIZAR".
                            ¿Esta seguro que desea confirmar esta acción?
                        </p>
                    {% endif %}
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" type="button" data-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary btn-sm" type="button"
                            {% if traslado.estado == '2' %}onclick="actualizarEstado()"{% endif %}
                            {% if traslado.estado == '1' or traslado.estado == '4' or traslado.estado == '5' %}
                            onclick="actualizarEstado2()"{% endif %}
                    >Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ver detalle de rechazo -->
    <div class="modal fade" id="verDetalleRechazo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Detalle de rechazo</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span
                            class="font-weight-light" aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <p>{{ traslado.detalleRechazo }}</p>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" type="button" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Ver detalle de rechazo -->
    <div class="modal fade" id="modalEliminarDocumento" tabindex="-1" role="dialog"
         aria-labelledby="modalEliminarDocumentoLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarDocumentoLabel">Confirmación</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span
                            class="font-weight-light" aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body" id="nombreModal">

                </div>

                <div class="modal-footer" id="botonesModal">

                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extrajs %}
    <script src="{% static 'lib/flatpickr/flatpickr.min.js' %}"></script>
    <script src="{% static 'lib/datatables-1.10.20/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'lib/jquery-validation/jquery.validate.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.js"></script>

    <script>

        let patrimoniosLista = [];
        var objeto;

        function abrirModalEliminar(btn, pk, archivo) {

            $('#modalEliminarDocumento').modal('show');

            objeto = btn;

            var botones = '<button class="btn btn-secondary btn-sm" type="button" data-dismiss="modal">Cerrar</button>' +
                '<button class="btn btn-primary btn-sm" type="button" onclick="eliminaDocumento(' + pk + ')" data-dismiss="modal">Confirmar</button>';
            var texto = '<p>Desea eliminar el archivo "' + archivo + '"</p>';

            $("#nombreModal").html(texto);
            $("#botonesModal").html(botones);
        }


        function eliminaDocumento(pk) {
            console.log("Elimnar cocumneto");
            console.log(pk);

            var btn = objeto;

            $('#modalEliminarDocumento').modal('show');

            var columna = btn.parentNode.parentNode.parentNode;

            $.ajax({
                type: 'POST',
                url: "{% url 'eliminarDocumentoTraslado'%}",
                async: false,
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    documento: pk,
                    traslado: {{ idEditar }}
                },
                success: function (response) {
                    let resultado = response['existe'];
                    columna.parentNode.removeChild(columna);
                    $.toast({
                        text: 'Documento eliminado con éxito',
                        icon: 'success',
                        loader: false,        // Change it to false to disable loader
                        bgColor: '#B7E6CA',  // To change the background
                        textColor: '#000000',
                        position: 'bottom-right',
                        hideAfter: 3000,
                    })
                },
                error: function (response) {
                    // alert the error if any error occured
                    console.log(response);
                    $.toast({
                        text: 'Ocurrió un error inesperado',
                        icon: 'warning',
                        loader: false,        // Change it to false to disable loader
                        bgColor: '#c67a71',
                        textColor: '#000000',
                        position: 'bottom-right',
                        hideAfter: 3000,
                    })
                }
            });
        }


        jQuery.validator.addMethod("alphanumeric", function (value, element) {
            return this.optional(element) || /^[\w\-\s]+$/i.test(value);
        }, "Letters, numbers, and underscores only please");

        jQuery.validator.addMethod("alphanumericNombreExpo", function (value, element) {
            return this.optional(element) || /^[\w\-\s\-]+$/i.test(value);
        }, "Letters, numbers, and underscores only please");

        jQuery.validator.addMethod("regexResolucion", function (value, element) {
            return this.optional(element) || /[0-9][0-9][0-9][0-9][0-9][0-9]+-[1-2][0-9][0-9][0-9]+-[SM][TC]+$/i.test(value);
        }, "Letters, numbers, and underscores only please");

        $("form[name='formAgregar']").validate({
            rules: {
                destino: {
                    required: true,
                    maxlength: 100,
                    alphanumeric: true
                },
                nombreExposicion: {
                    required: true,
                    maxlength: 100,
                    alphanumericNombreExpo: true
                },
                nResolucion: {
                    required: true,
                    regexResolucion: true
                },
            },
            messages: {
                destino: {
                    required: "Debe ingresar el destino del traslado",
                    maxlength: "El destino no debe tener más de 100 caracteres",
                    alphanumeric: "El destino solo debe contener carácteres alfanuméricos"
                },
                nombreExposicion: {
                    required: "Debe ingresar el nombre de la Exposición",
                    maxlength: "El nombre de la exposición no debe tener más de 100 caracteres",
                    alphanumericNombreExpo: "El destino solo debe contener carácteres alfanuméricos incluido" +
                        " guión(-) y guión bajo (_)"
                },
                nResolucion: {
                    required: "Debe ingresar el número de Resolución",
                    regexResolucion: "El número de resolución debe ser una cadena conformada por 3 campos" +
                        " (un número de 6 dígitos, el año actual y las letras “ST/MC”) separadas por un guion. "
                },
            },
            submitHandler: function (form, e) {
                e.preventDefault();
                if ($("#formAgregar").valid()) {
                    var patrimoniosEvaluar = ValidarPatrimonio();
                    var nResolucion = false;
                    if ("{{ traslado.estado }}" === '1') {
                        nResolucion = ValidarResolucion();
                    }

                    //TODO FIX
                    {#var fechasCorrectas = ValidarFechas();#}
                    var fechasCorrectas = true;
                    if (!nResolucion && fechasCorrectas) {
                        console.log("Todo Bien Miguel!");
                        form.submit();
                    } else if (!patrimoniosEvaluar) {
                        $("#modalPatrimonios").modal('show');
                    } else if (!fechasCorrectas) {
                        $("#modalFecha").modal('show');
                    } else if (nResolucion) {
                        $("#modalNombreCodigo").modal('show');
                    }
                }
                return false;

                function ValidarResolucion() {
                    return $.ajax({
                        type: 'POST',
                        url: "{% url 'validarResolucion'%}",
                        async: false,
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                            nResolucion: $("#nResolucion").val(),
                            operacion: '{{ operacion }}',
                            idEditar: '{{ idEditar }}',
                            estado: '{{ estado }}',
                        },
                        success: function (response) {
                            let resultado = response['existe'];
                        },
                        error: function (response) {
                            // alert the error if any error occured
                            console.log(response);
                        }
                    }).responseJSON['existe'];
                }

                function ValidarFechas() {
                    var fechainicial = document.getElementById("fechaSalidaProgramada").value;
                    var fechafinal = document.getElementById("fechaRetornoProgramada").value;

                    var fechaIni = new Date(fechainicial);
                    var fechaFin = new Date(fechafinal);

                    return (fechaFin > fechaIni);
                }

                function ValidarPatrimonio() {
                    console.log(patrimoniosLista.length);
                    return (patrimoniosLista.length > 0);
                }
            }
        });


        $(document).ready(function () {

            if ("{{ traslado.estado}}" === '2') {
                validar_campo_detalle();
            }

            if ("{{ operacion }}" === "editar") {
                $("#pais").val("{{ traslado.pais }}").change();
                $("#nombreInstitucion").val("{{ traslado.entidadSolicitante_id }}").change();
                $("#comisario").val("{{ traslado.gestorConservacionTraslados_id }}").change();

                console.log("Antes del parse");
                console.log("{{ lista }}");
                var array = JSON.parse("{{ lista }}");
                console.log("Despues del parse");
                console.log(array);

                for (let i = 0; i < array.length; i++) {
                    patrimoniosLista.push(array[i].toString());
                }
                console.log(patrimoniosLista);
            }
            ;

            $("#agr").on('click', function () {
                if ($("#formAgregar").valid()) {

                    var nResolucion = false;
                    if ("{{ traslado.estado }}" === '1') {
                        nResolucion = ValidarResolucion();
                    }

                    var patrimoniosEvaluar = ValidarPatrimonio();
                    {#var fechasCorrectas = ValidarFechas();#}
                    //TODO FIX
                    var fechasCorrectas = true;
                    if (!nResolucion && fechasCorrectas & patrimoniosEvaluar) {
                        console.log("Todo Bien Juan!");
                        $("#formAgregar").submit();
                    } else if (!patrimoniosEvaluar) {
                        $("#modalPatrimonios").modal('show');
                    } else if (!fechasCorrectas) {
                        $("#modalFecha").modal('show');
                    } else if (nResolucion) {
                        $("#modalNombreCodigo").modal('show');
                    }
                }
                return false;
            });

            function ValidarResolucion() {
                return $.ajax({
                    type: 'POST',
                    url: "{% url 'validarResolucion'%}",
                    async: false,
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        nResolucion: $("#nResolucion").val(),
                        operacion: '{{ operacion }}',
                        idEditar: '{{ idEditar }}',
                        estado: '{{ estado }}',

                    },
                    success: function (response) {
                        let resultado = response['existe'];
                    },
                    error: function (response) {
                        // alert the error if any error occured
                        console.log(response);
                    }
                }).responseJSON['existe'];
            }


            function ValidarPatrimonio() {
                return (patrimoniosLista.length > 0);
            }


            $("#patrimonio_select").select2({
                placeholder: "Select a State",
                allowClear: true
            });

            $('#patrimonio').select2({
                language: {
                    noResults: function (params) {
                        return "No se encontraron resultados";
                    },
                    errorLoading: function (params) {
                        return "Introduzca algún caracter para iniciar busqueda";
                    },

                },
                ajax: {
                    url: "{% url 'listPatrimoniosAjax'%}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data) {
                        let patrimoniosResultado = JSON.parse(data["patrimoniosAjax"]);
                        data = patrimoniosResultado.map(function (item) {
                            return {
                                id: item.id,
                                text: item.nombreTituloDemoninacion,
                                tipoPatrimonio: item.tipoPatrimonio,
                                categoria: item.categoria,
                                estado: item.estado,
                            };
                        });
                        return {results: data};
                    },
                    cache: true
                },
            });
            getEmail();
        });


        function set_validate() {
            if ($("#estadoSolicitud").val() === "3") {
                $("#inputDetalle").show();
                $("#detalleRechazo").attr('required', true);
                console.log("Campo detalle requerido");

                var settings = $('#formularioActualizarEstado').validate().settings;
                console.log(settings);
                $.extend(settings, {
                    rules: {
                        detalleRechazo: {
                            required: true,
                        },
                    },
                    messages: {
                        detalleRechazo: {
                            required: "Debe ingresar un detalle del rechazo",
                        },
                    }
                });
            } else {
                console.log("Campo detalle no requerido");

                $("#detalleRechazo").attr('required', false);
                $("#inputDetalle").hide();
                var settings = $('#formularioActualizarEstado').validate().settings;
                console.log(settings);

                $.extend(settings, {
                    rules: {
                        detalleRechazo: {
                            required: false,
                        },
                    },
                });
            }
        }


        function validar_campo_detalle() {

            set_validate();

            if ($("#estadoSolicitud").val() === "3") {
                $("#detallarRechazo").show();
            } else {
                $("#detallarRechazo").hide();
            }
        }


        $('#formularioActualizarEstado').validate({

            submitHandler: function (form) {
                $.ajax({
                    type: 'POST',
                    url: "{% url 'actualizar_estado'%}",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        traslado_pk: {{ idEditar }},
                        {#estado: {{ traslado.pk }},#}
                        nuevo_estado: $("#estadoSolicitud").val(),
                        detalle_rechazo: $("#detalleRechazo").val()
                    },
                    success: function (response) {
                        $("#estadoSolicitud").empty();
                        $("#detalleRechazo").empty();
                        $('#actualizarEstado').hide()

                        location.reload();

                    },
                    error: function (response) {
                        alert(response["responseJSON"]["error"]);
                    }
                });
            }
        });

        function actualizarEstado() {
            $('#formularioActualizarEstado').submit();
        }

        function actualizarEstado2() {
            $.ajax({
                type: 'POST',
                url: "{% url 'actualizar_estado_2'%}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    traslado_pk: {{ idEditar }},
                },
                success: function (response) {
                    location.reload();
                },
                error: function (response) {
                    console.log(response)
                }
            });
        }

        function getEmail() {
            $.ajax({
                type: 'POST',
                url: "{% url 'entidadEmail'%}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    entidad: $("#nombreInstitucion").val(),

                },
                success: function (response) {
                    $("#correoEntidadSolicitante").val(response['email']);
                },
                error: function (response) {
                    // alert the error if any error occured
                    console.log(response)
                }
            });
        }

        function eliminarPatrimonio(btn, idEliminar) {
            var row = btn.parentNode.parentNode;
            patrimoniosLista = jQuery.grep(patrimoniosLista, function (value) {
                return value != idEliminar;
            });
            row.parentNode.removeChild(row);
            $("#lista").val(patrimoniosLista);
            console.log("Eliminado");
            console.log(patrimoniosLista);
        }

        function agregarPatrimonioTabla() {
            let patrimonioAgregar = $("#patrimonio").select2('data');
            if (!patrimoniosLista.includes(patrimonioAgregar[0].id)) {
                patrimoniosLista.push(patrimonioAgregar[0].id);
                $("#lista").val(patrimoniosLista);
                data = '<tr>' +
                    '<td>' + patrimonioAgregar[0].id + '</td>' +
                    ' <td>' + patrimonioAgregar[0].text + '</td>' +
                    '<td>' + patrimonioAgregar[0].categoria + '</td>' +
                    '<td>' + patrimonioAgregar[0].tipoPatrimonio + '</td>' +
                    '<td>' + patrimonioAgregar[0].estado + '</td>' +
                    '<td>' +
                    '<button class="btn" href="#" type="button" onclick="eliminarPatrimonio(this,' + patrimonioAgregar[0].id + ')">' +
                    '<i class="fas fa-trash" data-fa-transform="shrink-3"></i>' +
                    '</button>' +
                    '</td>' +
                    '</tr>';
                $("#patrimonioAgregar").append(data);
                console.log("Agregado");
                console.log(patrimoniosLista);
            }
        }

    </script>
{% endblock %}