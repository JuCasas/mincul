{% extends 'proyectoConservacion/components/base.html' %}
{% load static %}

{% block extrastyle %}
  <link href="{% static 'lib/flatpickr/flatpickr.min.css' %}" rel="stylesheet">
  <link href="{% static 'lib/datatables-1.10.20/css/jquery.dataTables.css' %}" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.css" rel="stylesheet">
  <style>
      .jq-toast-wrap {
          width: 500px;
      }

      #cover-spin {
          position: fixed;
          width: 100%;
          left: 0;
          right: 0;
          top: 0;
          bottom: 0;
          background-color: rgba(255, 255, 255, 0.7);
          z-index: 9999;
          display: none;
      }

      @-webkit-keyframes spin {
          from {
              -webkit-transform: rotate(0deg);
          }
          to {
              -webkit-transform: rotate(360deg);
          }
      }

      @keyframes spin {
          from {
              transform: rotate(0deg);
          }
          to {
              transform: rotate(360deg);
          }
      }

      #cover-spin::after {
          content: '';
          display: block;
          position: absolute;
          left: 48%;
          top: 40%;
          width: 40px;
          height: 40px;
          border-style: solid;
          border-color: black;
          border-top-color: transparent;
          border-width: 4px;
          border-radius: 50%;
          -webkit-animation: spin .8s linear infinite;
          animation: spin .8s linear infinite;
      }

      .table.dataTable tbody th, table.dataTable tbody td {
          padding: 8px 10px 8px 18px !important;
      }

      .modal-body {
          background-color: #F7F8FB !important;
      }

      .form-control {
          background-color: white !important;
          cursor: pointer!important;
      }

      .second {
          background-color: white !important;
          color: #2B2D42 !important;
          border-color: #8d8e99 !important;
          border-radius: 12px !important;
          height: 36px !important;
          font-size: 12px !important;
      }

      span.select2-selection.select2-selection--single{
          display: flex!important;
          align-items: center!important;
      }

      span.select2-selection__arrow{
          margin-top: 5px!important;
          display: none!important;
      }

      span.select2-selection__arrow > i.fa.fa-chevron-right:before {
        content: "\f0fe";
        }

      span.select2-selection__arrow{
          margin-top: 5px!important;
      }

      .select2-selection{
          height: 36px!important;
          border-radius: 10px!important;
          border-color: #D7E1EE!important;
          align-items: center!important;
      }

      .select2-selection__placeholder{
          align-items: center!important;
          font-size: 12px!important;
          color: #BDC1D2!important;
      }

      .inputIcon2{
          color: #393e44 !important;
          font-size: 10px!important;
          margin-top: 2px;
      }

  </style>

{% endblock %}

{% block body %}

  <div class="card mb-3">
    <div class="card-body cardRed">
      <div class="row justify-content-between align-items-center">
        <div class="col-md-12">
          <h5 class="mb-2 mb-md-0 text-black">Proyectos de Conservación</h5>
        </div>
      </div>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <div class="row filterBar mr-0">
        <div class="form-group col-sm-3 mb-0">
          <div class="position-relative">
            <input class="form-control" id="search" type="text" placeholder="Nombre">
            <span class="fas fa-search inputIcon" data-fa-transform="shrink-3"></span>
          </div>
        </div>

        <div class="form-group col-sm-3 mb-0">
          <select class="selectpicker form-control" id="patrimonio" name="patrimonio">
          </select>
            <span class="fas fa-chevron-down inputIcon inputIcon2 mr-3"></span>
        </div>

        <div class="form-group col-sm-2 mb-0">
          <select class="form-control" id="status_filter">
            <option value="" selected>Estados</option>
            {% for mykey,myvalue in status_choices %}
              <option value="{{ mykey }}">{{ myvalue }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group col-sm-2 mb-0">
          <select class="form-control" id="type_filter">
            <option value="" selected>Tipos</option>
            {% for mykey,myvalue in typeProjects %}
              <option value="{{ mykey }}">{{ myvalue }}</option>
            {% endfor %}
          </select>
        </div>

        <button class="btn btn-primary col-sm-2 mb-0" type="button" data-dismiss="modal" id="new">
          <span class="fas fa-plus mr-1" data-fa-transform="shrink-3"></span>Agregar Proyecto
        </button>
      </div>
      {#      <div class="row justify-content-end">#}
      {#        <div class="form-group col-sm-2">#}
      {#          <select class="form-control" id="exampleFormControlSelect4">#}
      {#            <option>1</option>#}
      {#            <option>2</option>#}
      {#            <option>3</option>#}
      {#            <option>4</option>#}
      {#            <option>5</option>#}
      {#          </select>#}
      {#        </div>#}
      {#        <div class="form-group col-sm-2">#}
      {#          <select class="form-control" id="exampleFormControlSelect5">#}
      {#            <option>1</option>#}
      {#            <option>2</option>#}
      {#            <option>3</option>#}
      {#            <option>4</option>#}
      {#            <option>5</option>#}
      {#          </select>#}
      {#        </div>#}
      {#      </div>#}
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <table id="tabla_autores" class="table table-sm table-dashboard data-table no-wrap mb-0 fs--1 w-100">
        <thead class="bg-200">
        <tr>
          <th class="sort ">Código</th>
          <th class="sort">Nombre</th>
          <th class="sort">Tipo de Plan</th>
          <th class="sort">Act. Completadas</th>
          <th class="sort">F. Registro</th>
          <th class="sort">Estado</th>
          <th class="sort">Acciones</th>
        </tr>
        </thead>
        <tbody class="bg-white">

        </tbody>
      </table>
    </div>
  </div>

  <!-- NEW and EDIT Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog mw-100 w-50">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_title"></h4>
        </div>
        <div class="modal-body">
          <form id="formProyecto" name="formProyecto">
            <div class="row">
              <div class="form-group col-lg-6 col-sm-12">
                <label for="codigo"><span class="glyphicon glyphicon-eye-open"></span> Código</label>
                <input type="text" class="form-control" id="codigo" name="codigo" placeholder=""
                >
              </div>

              <div class="form-group col-lg-6 col-sm-12">
                <label for="nombre"><span class="glyphicon glyphicon-file"></span> Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre"
                       placeholder="">
              </div>
            </div>

            <div class="row">
              <div class="form-group col-lg-6 col-sm-12">
                <label for="tipoPlan"><span class="glyphicon glyphicon-eye-open"></span> Tipo de Plan</label>
                <select class="form-control" name="tipoPlan" id="tipoPlan">
                  <option value=0>Preventivo</option>
                  <option value=1>Correctivo</option>
                  <option value=2>Curativo</option>
                </select>
              </div>

              <div class="form-group col-lg-6 col-sm-12">
                <label for="fechaRegistro"><span class="glyphicon glyphicon-eye-open"></span> Fecha de Registro</label>
                <input class="form-control pointer-event-none" id="fechaRegistro" name="fechaRegistro" type="date">
              </div>
            </div>

            <div class="row justify-content-end mt-2 mr-1">

              <button type="button" data-dismiss="modal" class="btn second mr-3">Cancelar</button>

              <div>
                <input type="hidden" id="type" name="type" value="">
                <button id="submit" class="btn btn-primary"><span
                    class="glyphicon glyphicon-ok"></span> Guardar
                </button>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal fade" id="confirm" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header justify-content-center">
          <h4 class="modal-title">¿Estás seguro de eliminar el proyecto?</h4>
        </div>
        <div class="modal-body px-9">
          <div class="row justify-content-between">
            <button type="button" data-dismiss="modal" class="btn second">Cancelar</button>
            <button type="button" data-dismiss="modal" class="btn btn-primary" id="delete">Eliminar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="cover-spin"></div>

{% endblock %}

{% block extrajs %}
  <script src="{% static 'lib/flatpickr/flatpickr.min.js' %}"></script>
  <script src="{% static 'lib/datatables-1.10.20/js/jquery.dataTables.min.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.js"></script>
  <script src="{% static 'project/projects/projects.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>


  <script>

    jQuery.validator.addMethod("alphanumeric", function (value, element) {
      return this.optional(element) || /^[a-zA-Z0-9]+$/i.test(value);
    }, "Letters, numbers, and underscores only please");

    $("form[name='formProyecto']").validate({
      rules: {
        codigo: {
          required: true,
          maxlength: 8,
          alphanumeric: true
        },
        nombre: {
          required: true,
          maxlength: 50,
        },
      },
      messages: {
        codigo: {
          required: "Debe ingresar el código del proyecto",
          maxlength: "El código no debe tener más de 8 caracteres",
          alphanumeric: "El código solo debe contener carácteres alfanuméricos"
        },
        nombre: {
          required: "Debe ingresar el nombre del proyecto",
          maxlength: "El nombre no debe tener más de 50 caracteres",
        }
      },
      submitHandler: function (form, e) {
        e.preventDefault();
        let type = $('#type').val();
        let method = '';
        let url = '/conservacion/proyectos/';
        if (type == 'new') {
          // new
          url = url + 'add/';
          method = 'POST';
        } else {
          // edit
          url = url + 'edit/' + id + '/';
          method = 'POST';
        }
        $('#cover-spin').show(0)
        $.ajax({
          url: url,
          method: method,
          data: {
            'codigo': $("#codigo").val(),
            'nombre': $("#nombre").val(),
            'tipoPlan': $("#tipoPlan").val()
          },
          success: function (response) {
            $('#cover-spin').hide()
            if (response["success"] !== undefined) {
              $.toast({
                heading: 'Information',
                text: response['message'],
                icon: 'warning',
                loader: true,        // Change it to false to disable loader
                loaderBg: '#9EC600',  // To change the background
                position: 'top-center',
                hideAfter: 3000,
              })
            } else {
              $('#myModal').modal('hide')
              $("#tabla_autores").DataTable().draw();
              $.toast({
                heading: 'Information',
                text: 'Loaders are enabled by default. Use `loader`, `loaderBg` to change the default behavior',
                icon: 'info',
                loader: true,        // Change it to false to disable loader
                loaderBg: '#9EC600',  // To change the background
                position: 'top-center',

                hideAfter: 5000,
              })
            }
          },
          error: function (error) {
            $('#cover-spin').hide()
            console.log(error)
          }
        });
        return false;
      }
    });

    $(document).ready(function () {
      $('#patrimonio').select2({
        ajax: {
          url: '/conservacion/proyectos/patrimonios',
          datatype: 'json',
          delay: 250,
          data: function (params) {
            return {
              search: params.term || '',
              page: params.page || 1
            };
          },
          processResults: function (data, params) {
            params.page = params.page || 1;
            console.log(data.items)
            return {
              results: $.map(data.items, function (obj, index) {
                return {id: obj.id, text: obj.nombreTituloDemoninacion};
              }),
              pagination: {
                more: (params.page * 10) < data.total_count
              }
            }
          }
        },
        placeholder: "Patrimonio",
        allowClear: true,
        cache: false
      });

      $('#patrimonio').on("select2:clear", function (evt) {
        $(this).on("select2:opening.cancelOpen", function (evt) {
          evt.preventDefault();

          $(this).off("select2:opening.cancelOpen");
        });
      });


    });
  </script>
{% endblock %}