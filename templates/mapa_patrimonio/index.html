{% extends 'base/base.html' %}
{% load static %}

{% block extrastyle %}
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link href="{% static 'lib/flatpickr/flatpickr.min.css' %}" rel="stylesheet">
    <link href="../../static/lib/raty-js/jquery.raty.css" rel="stylesheet">
    <style>
        .filtrosBusqueda{
            margin-left: 6rem;
            width: 20rem;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="filtrosBusqueda">
        <div class="row">
            <input type="text" id="txtDireccionPartida" class="form-control" placeholder="Ingrese su dirección de partida">
        </div>
        <br>
        <div class="row">
            <input type="text" id="txtDireccionLlegada" class="form-control" placeholder="Ingrese su dirección de llegada">
        </div>
        <br>
        <div>100m <input type="range" min="100" max="2000" value="600" data-color="#f00" class="" id="sliderDispersion" /> 2000m 
        <input type="number" min="100" max="2000" value="600" class="" id="inputDispersion" disabled/></div>
        <br>
        <button id="btnGenerarRuta" onclick="generarRuta()">Generar Ruta</button>
    </div>
    <br>
    <div class="col-md-10 offset-md-1" id="map" style="width:100%;height:100vh">
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
            crossorigin="anonymous"></script>
{% endblock %}

{% block extrajs %}
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh5T6LTIqW_gSbFZITGcZFJkOVHsqqrMY"></script>
    <script>
        const LATITUD_CENTRO_PERU=-11;
        const LONGITUD_CENTRO_PERU=-77;
        const ZOOM_CENTRO_PERU=6;
        const LATITUD_METROS=111100;
        const LONGITUD_METROS=110400;//no es exacto, pero como perú está cerca de la línea ecuatorial, es aproximado

        var zoomActual=0;
        var map = L.map('map').setView([LATITUD_CENTRO_PERU, LONGITUD_CENTRO_PERU],ZOOM_CENTRO_PERU);
        var tileLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: "OSM"}).addTo(map);
        var geocoder = new google.maps.Geocoder();
        var controlRuta = null;
        var grupoMarcadores = L.layerGroup().addTo(map);
        var patrimoniosCercanos = null;
        var puntoPartidaIcon = L.icon({
            iconUrl : '../../static/img/icons/punto-partida.png',
            iconSize: [24,35]
        });
        var puntoLlegadaIcon = L.icon({
            iconUrl : '../../static/img/icons/punto-llegada.png',
            iconSize: [24,35]
        });
        var institucionesIcon = L.icon({
            iconUrl : '../../static/img/icons/instituciones.png',
            iconSize: [30,30]
        });
        var patrimonioIcon = L.icon({
            iconUrl : '../../static/img/icons/patrimonios.png',
            iconSize: [30,30]
        });
        var inmaterialesIcon = L.icon({
            iconUrl : '../../static/img/icons/inmateriales.png',
            iconSize: [30,30]
        })
        var leyenda = L.control({position: 'bottomleft'});
        leyenda.onAdd = function (map){
            var div = L.DomUtil.create('div', 'info leyenda');
            div.innerHTML +=
                '<img alt="leyenda" src="../../static/img/icons/leyenda.png" width="550" height="40" />';
            return div;
        }
        leyenda.addTo(map);

        var dispersion = $('#sliderDispersion').val();
        $('#sliderDispersion').change(function(){
            if($('#sliderDispersion').val()!=dispersion){
                dispersion=$('#sliderDispersion').val();
                let inputDispersion=document.getElementById('inputDispersion');
                inputDispersion.value=dispersion;
            }
        })
        
        async function obtenerLatitudLongitudConDireccion(direccion){
            let lat=0;
            let long=0;
            await geocoder.geocode({
                "address": direccion
            }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    lat=results[0].geometry.location.lat();
                    long=results[0].geometry.location.lng();
                }
            });
            return [lat, long];
        }
        function limpiarMapa(){
            map.removeControl(controlRuta);
            grupoMarcadores.clearLayers();
            controlRuta=null;
            patrimoniosCercanos=null;
        }
        async function obtenerPatrimoniosCercanos(lat1,long1,lat2,long2){
            return $.ajax({
                type: "POST",
                url: "/mapa_patrimonio/mapa/datos",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    latitudIni:lat1,
                    longitudIni:long1,
                    latitudFin:lat2,
                    longitudFin:long2,
                },
            });
        }
        function crearDivPatrimonio(patrimonioDatos){
            return '<div>' + '<h3 style="text-align: center">'+patrimonioDatos.nombreTituloDemoninacion+'</h3>'+
                '<img src="'+ patrimonioDatos.url+'" height="100px" width="300px"/>'+'</div>';
        }
        function anadirPatrimoniosCercanos(){
            for(let i=0;i<patrimoniosCercanos.data.length;i++){
                if(patrimoniosCercanos.data[i].tipoPatrimonio==1){//inmaterial
                    let markerInicio = L.marker([patrimoniosCercanos.data[i].lat, patrimoniosCercanos.data[i].long], {
                        icon: inmaterialesIcon,
                        title: patrimoniosCercanos.data[i].nombreTituloDemoninacion,
                    }).addTo(grupoMarcadores).bindPopup(crearDivPatrimonio(patrimoniosCercanos.data[i]));
                }else if(patrimoniosCercanos.data[i].tipoPatrimonio==2){//material inmueble
                    let markerInicio = L.marker([patrimoniosCercanos.data[i].lat, patrimoniosCercanos.data[i].long], {
                        icon: patrimonioIcon,
                        title: patrimoniosCercanos.data[i].nombreTituloDemoninacion,
                    }).addTo(grupoMarcadores).bindPopup(crearDivPatrimonio(patrimoniosCercanos.data[i]));
                }else{//ver lo de agruparlos en institución
                    
                }
            }
        }
        async function generarRutaDispersion(lat1,long1,lat2,long2){
            let patrimoniosEnDispersion=[];
            for(let i=0;i<patrimoniosCercanos.data.length;i++){
                
            }
            controlRuta = L.Routing.control({
                createMarker: function () { return null; },
                lineOptions : {
                    addWaypoints: false
                },
                waypoints: [    
                    L.latLng(lat1, long1),
                    L.latLng(lat2, long2),
                    L.latLng(-12.0983342, -76.9799472),
                ],
                language:'es',
            }).addTo(map);
        }
        async function generarRuta() {
            if(controlRuta!=null){
                limpiarMapa();
            }
            let direccionPartida = $("#txtDireccionPartida").val();
            let direccionLlegada = $("#txtDireccionLlegada").val();
            let latLongPartida = await obtenerLatitudLongitudConDireccion(direccionPartida);
            let latLongLlegada = await obtenerLatitudLongitudConDireccion(direccionLlegada);
            let latitudDireccionPartida = latLongPartida[0];
            let longitudDireccionPartida = latLongPartida[1];
            let latitudDireccionLlegada = latLongLlegada[0];
            let longitudDireccionLlegada = latLongLlegada[1];
            console.log(latitudDireccionPartida,longitudDireccionPartida,latitudDireccionLlegada,longitudDireccionLlegada);
            await obtenerPatrimoniosCercanos(latitudDireccionPartida,longitudDireccionPartida,latitudDireccionLlegada,longitudDireccionLlegada).
                then(datos=>{
                    patrimoniosCercanos=datos;
                });
            console.log(patrimoniosCercanos);
            let markerInicio = L.marker([latitudDireccionPartida, longitudDireccionPartida], {
                icon: puntoPartidaIcon,
                title: "Partida"
            }).addTo(grupoMarcadores);
            let markerLlegada = L.marker([latitudDireccionLlegada, longitudDireccionLlegada], {
                icon: puntoLlegadaIcon,
                title: "Llegada"
            }).addTo(grupoMarcadores);
            await anadirPatrimoniosCercanos();
            await generarRutaDispersion(latitudDireccionPartida,longitudDireccionPartida,latitudDireccionLlegada,longitudDireccionLlegada);
        }
    </script>

{% endblock %}