{% extends 'base/base.html' %}
{% load static %}

{% block extrastyle %}
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link href="{% static 'lib/flatpickr/flatpickr.min.css' %}" rel="stylesheet">
    <link href="../../static/lib/raty-js/jquery.raty.css" rel="stylesheet">
    <style>
        .filtrosBusqueda{
            margin-left: 6rem;
            width: 20rem;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="col-md-4" style="padding-left:30px; padding-top: 15px; overflow-y: scroll; ">
        <nav class="card mb-3" style="height: 75vh">
        <!-- Content-->
        <div class="navbar-vertical-content">
            <div class="row" style="padding-bottom: 3px">
                <div class="col">
                    <form id="form_buscar" method="post" action="{% url 'mapaPatrimonioSimple' %}"
                            name = "formBuscar">
                        {% csrf_token %}
                        <div class="position-relative" style="padding: 10px;">
                            <label for="txtBuscar"></label>
                            <input name="patrimonio_name" class="form-control" id="txtBuscar"
                                placeholder="Buscar patrimonio...">
                        </div>
                        <div class="text-right" style="padding: 10px">
                            <a class="text-black" style="font-size: small" href="{% url 'mapaPatrimonioAvanzado' %}">
                                <u>Cambiar a búsqueda avanzada</u>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row" style="padding-bottom: 5px">
                <div class="col">
                    <div class="position-relative" style="padding: 5px;">
                        <button class="btn-primary text-white" type="submit" form="form_buscar" id="btn-submit">
                            Realizar Búsqueda
                        </button>
                    </div>
                </div>
            </div>
            <!--if queried, then it must show the # of results given, including case 0-->
            {% if success != -1 %}
                <div class="row">
                    <div class="col">
                        {% if success == 0 %}
                        <p>No se encontraron resultados</p>
                        {% elif success == 1 %}
                            {% if lensearch == 1 %}
                                <p> Se encontró {{  lensearch }} patrimonio o institución asociada</p>
                            {% else %}
                                <p> Se encontraron {{  lensearch }} patrimonios o instituciones asociadas</p>
                            {% endif %}
                        {% else %}
                                <!--Nothing-->
                        {% endif %}
                    </div>
                </div>
                {% for p in patrimonios %}
                    <div class="card mb-5" style="padding: 10px;margin-top: 10px;">
                        <div class="position-relative">
                            <div>
                                <img class="img-fluid w-100"
                                    style="height: 130px; object-fit: cover; border-top-left-radius: 20px; border-top-right-radius: 20px"
                                    src="{{ p.url }}"
                                    alt="Card image"/>
                            </div>
                            <div class="card-img-overlay d-flex align-items-end text-white pb-2">
                                <p class="card-text "
                                style="font-size: 15px;font-weight: bold; text-shadow : 1px 1px black;">
                                    {{ p.patrimonio.nombreTituloDemoninacion }}</p>
                            </div>
                        </div>
                        <div class="card-body pt-2 pb-2">
                            {% if p.patrimonio.tipoPatrimonio == "1" %}
                                <p class="mb-0 " style="font-size: 15px"> Patrimonio Inmaterial </p>
                            {% else %}
                                <p class="mb-0 " style="font-size: 15px"> Patrimonio Material Inmueble </p>
                            {% endif %}

                            <button class="btn bg-200 mr-1 mb-1 w-100" type="button" style="font-size: 10px"
                                    value="{{ p.patrimonio.id }},1">
                                        Ver en el mapa
                            </button>

                            <a href="{% url 'detalle' pk=p.patrimonio.pk %}">
                                <button class="btn btn-dark mr-1 mb-1 w-100" type="button"
                                        style="font-size: 10px">
                                            Ver Ficha
                                </button>
                            </a>
                        </div>
                    </div>
                {% endfor %}
                {% for i in instituciones %}
                    <div class="card mb-5" style="padding: 10px;margin-top: 10px;">
                        <div class="position-relative">
                            <div>
                                <img class="img-fluid w-100"
                                    style="height: 130px; object-fit: cover; border-top-left-radius: 20px; border-top-right-radius: 20px"
                                    src="{{ i.url }}"
                                    alt="Card image"/>
                            </div>
                            <div class="card-img-overlay d-flex align-items-end text-white pb-2">
                                <p class="card-text "
                                style="font-size: 15px;font-weight: bold; text-shadow : 1px 1px black;">
                                    {{ i.institucion.nombre}}</p>
                            </div>
                        </div>
                        <div class="card-body pt-2 pb-2">
                            <p class="mb-0 " style="font-size: 15px"> Institución </p>
                            <button class="btn bg-200 mr-1 mb-1 w-100" type="button" style="font-size: 10px"
                                    value="{{ i.institucion.pk }},2">
                                        Ver en el mapa
                            </button>
                            <a href="{% url 'detalle_museo' pk=i.institucion.pk %}">
                                <button class="btn btn-dark mr-1 mb-1 w-100" type="button"
                                        style="font-size: 10px">
                                            Ver detalle
                                </button>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </nav>
    </div>
    <div class="filtrosBusqueda">
        <br><br><br><br>
        <div class="row">
            <input type="text" id="txtDireccionPartida" class="form-control" placeholder="Ingrese su dirección de partida">
        </div>
        <br>
        <div class="row">
            <input type="text" id="txtDireccionLlegada" class="form-control" placeholder="Ingrese su dirección de llegada">
        </div>
        <br>
        <!--<div>0m <input type="range" min="0" max="2000" value="0" data-color="#f00" class="" id="sliderDispersion" /> 2000m 
        <input type="number" min="0" max="2000" value="0" class="" id="inputDispersion" disabled/></div>
        <br>-->
        <button id="btnGenerarRuta" onclick="generarRuta()">Generar Ruta</button>
    </div>
    <br>
    <div class="col-md-10 offset-md-1" id="map" style="width:100%;height:100vh">
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
            crossorigin="anonymous"></script>
{% endblock %}

{% block extrajs %}
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh5T6LTIqW_gSbFZITGcZFJkOVHsqqrMY"></script>
    <script>
        const LATITUD_CENTRO_PERU=-11;
        const LONGITUD_CENTRO_PERU=-77;
        const ZOOM_CENTRO_PERU=6;
        const LATITUD_METROS=111100;
        const LONGITUD_METROS_ECUADOR=111321;
        const RADIO_DE_LA_TIERRA_PROMEDIO_PERU=6377.0854565;
        const PORCENTAJE_DISPERSION=0.15;
        const MAX_DISPERSION=2000;//en metros
        

        var zoomActual=0;
        var map = L.map('map').setView([LATITUD_CENTRO_PERU, LONGITUD_CENTRO_PERU],ZOOM_CENTRO_PERU);
        var tileLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: "OSM"}).addTo(map);
        var geocoder = new google.maps.Geocoder();
        var controlRuta = null;
        var grupoMarcadoresRuta = L.layerGroup().addTo(map);
        var grupoMarcadoresFueraRuta = L.layerGroup().addTo(map);
        var patrimoniosEnRuta = null;
        var patrimoniosFueraRuta = null;
        var numPatrimoniosEnRuta=0;
        var dispersion=-1;//por defecto será un 0.2 de la distancia original de la ruta, hasta un máximo de 2km
        var esquinasMapa={
            noroeste:null,
            noreste:null,
            suroeste:null,
            sureste:null,
        }
        var puntoPartidaIcon = L.icon({
            iconUrl : '../../static/img/icons/punto-partida.png',
            iconSize: [24,35]
        });
        var puntoLlegadaIcon = L.icon({
            iconUrl : '../../static/img/icons/punto-llegada.png',
            iconSize: [24,35]
        });
        var institucionesIcon = L.icon({
            iconUrl : '../../static/img/icons/instituciones.png',
            iconSize: [30,30]
        });
        var patrimonioIcon = L.icon({
            iconUrl : '../../static/img/icons/patrimonios.png',
            iconSize: [30,30]
        });
        var inmaterialesIcon = L.icon({
            iconUrl : '../../static/img/icons/inmateriales.png',
            iconSize: [30,30]
        })
        var leyenda = L.control({position: 'bottomleft'});
        leyenda.onAdd = function (map){
            var div = L.DomUtil.create('div', 'info leyenda');
            div.innerHTML +=
                '<img alt="leyenda" src="../../static/img/icons/leyenda.png" width="550" height="40" />';
            return div;
        }
        leyenda.addTo(map);

        var dispersionValor = $('#sliderDispersion').val();
        $('#sliderDispersion').change(function(){
            if($('#sliderDispersion').val()!=dispersionValor){
                dispersionValor=$('#sliderDispersion').val();
                let inputDispersion=document.getElementById('inputDispersion');
                inputDispersion.value=dispersionValor;
            }
        });
        map.on('moveend',function(){
            obtenerCoordenadasEsquinaMapa();
            distanciaEntreDosCoordenadas(esquinasMapa.noroeste.lat,esquinasMapa.noroeste.lng,esquinasMapa.sureste.lat,esquinasMapa.sureste.lng);
        });

        function obtenerCoordenadasEsquinaMapa(){
            let bounds=map.getBounds();
            esquinasMapa.noroeste=bounds.getNorthWest();
            esquinasMapa.noreste=bounds.getNorthEast();
            esquinasMapa.suroeste=bounds.getSouthWest();
            esquinasMapa.sureste=bounds.getSouthEast();
            console.log(esquinasMapa);
        }
        async function obtenerLatitudLongitudConDireccion(direccion){
            let lat=0;
            let long=0;
            await geocoder.geocode({
                "address": direccion
            }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    lat=results[0].geometry.location.lat();
                    long=results[0].geometry.location.lng();
                }
            });
            return [lat, long];
        }
        function limpiarMapa(){
            map.removeControl(controlRuta);
            grupoMarcadoresRuta.clearLayers();
            grupoMarcadoresFueraRuta.clearLayers();
            controlRuta=null;
            patrimoniosEnRuta=null;
            patrimoniosFueraRuta=null;
            
        }
        async function obtenerPatrimoniosCercanos(lat1,long1,lat2,long2,lat1menor,long1menor){
            return $.ajax({
                type: "POST",
                url: "/mapa_patrimonio/mapa/datos",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    latitudIni:lat1,
                    longitudIni:long1,
                    latitudFin:lat2,
                    longitudFin:long2,
                    latIniMenor:lat1menor,
                    longIniMenor:long1menor,
                },
            });
        }
        function crearDivPatrimonio(patrimonioDatos){
            return '<div>' + '<h3 style="text-align: center">'+patrimonioDatos.nombre+'</h3>'+
                '<img src="'+ patrimonioDatos.url+'" height="100px" width="300px"/>'+'</div>';
        }
        async function obtenerPatrimoniosFueraRuta(){
            return $.ajax({
                type: "POST",
                url: "/mapa_patrimonio/mapa/patrimoniosFueraRuta",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
            });
        }
        async function anadirPatrimoniosFueraRuta(){
            if(patrimoniosEnRuta==null){
                return;
            }
            
        }
        function anadirPatrimoniosEnRuta(){//tipo 2 para inmuebles, 4 para institucion
            for(let i=0;i<patrimoniosEnRuta.length;i++){
                if(patrimoniosEnRuta[i].tipo==2){
                    let markerInicio = L.marker([patrimoniosEnRuta[i].lat, patrimoniosEnRuta[i].long], {
                        icon: patrimonioIcon,
                        title: patrimoniosEnRuta[i].nombre,
                    }).addTo(grupoMarcadoresRuta).bindPopup(crearDivPatrimonio(patrimoniosEnRuta[i]));
                }else{
                    let markerInicio = L.marker([patrimoniosEnRuta[i].lat, patrimoniosEnRuta[i].long], {
                        icon: institucionesIcon,
                        title: patrimoniosEnRuta[i].nombre,
                    }).addTo(grupoMarcadoresRuta).bindPopup(crearDivPatrimonio(patrimoniosEnRuta[i]));
                }
            }
        }
        function ordenarPatrimoniosEnBasePuntoPartida(lat,long){//primero se irá al más cercano, luego al siguiente en cercanía, etc
            patrimoniosEnRuta.sort((a,b)=>{
                return distanciaEntreDosCoordenadas(lat,long,parseFloat(a.lat),parseFloat(a.long)) - distanciaEntreDosCoordenadas(lat,long,b.lat,b.long);
            });
            console.log(patrimoniosEnRuta); 
        }
        async function enrutamientoConPatrimonios(lat1,long1,lat2,long2){
            let puntosRuta=[];
            puntosRuta.push(L.latLng(lat1,long1));
            ordenarPatrimoniosEnBasePuntoPartida(lat1,long1);
            for(let i=0;i<patrimoniosEnRuta.length;i++){
                puntosRuta.push(L.latLng(patrimoniosEnRuta[i].lat,patrimoniosEnRuta[i].long))
            }
            puntosRuta.push(L.latLng(lat2,long2));
            controlRuta = await L.Routing.control({
                createMarker: function () { return null; },
                lineOptions : {
                    addWaypoints: false
                },
                waypoints: puntosRuta,
                language:'es',
            }).addTo(map);
        }
        async function generarRutaDispersion(lat1,long1,lat2,long2){
            let distanciaDispersion;
            let lat1menor=false;
            let long1menor=false;
            distanciaDispersion= dispersion==-1 ? PORCENTAJE_DISPERSION*distanciaEntreDosCoordenadas(lat1,long1,lat2,long2) : dispersion;
            if(distanciaDispersion>MAX_DISPERSION){
                distanciaDispersion=MAX_DISPERSION;
            }
            //esta en metros
            let nuevaLat1, nuevaLong1, nuevaLat2, nuevaLong2;
            if(long1<=long2){//se expande para la izquierda long1 y long2 para la derecha
                long1menor=true;
                nuevaLong1 = modificarLongitudDispersion(lat1,long1,distanciaDispersion*-1);
                nuevaLong2 = modificarLongitudDispersion(lat2,long2,distanciaDispersion);
            }else{//se expande para la izquierda long2 y long1 para la derecha
                nuevaLong1 = modificarLongitudDispersion(lat1,long1,distanciaDispersion);
                nuevaLong2 = modificarLongitudDispersion(lat2,long2,distanciaDispersion*-1);
            }
            console.log(lat1,lat2);
            if(lat1<=lat2){//se expande para abajo lat1 y lat2 para arriba
                lat1menor=true;
                nuevaLat1 = modificarLatitudDispersion(lat1,distanciaDispersion*-1);
                nuevaLat2 = modificarLatitudDispersion(lat2,distanciaDispersion);
            }else{//se expande para abajo lat2 y lat1 para arriba
                nuevaLat1 = modificarLatitudDispersion(lat1,distanciaDispersion);
                nuevaLat2 = modificarLatitudDispersion(lat2,distanciaDispersion*-1);
            }
            
            //back devuelve hasta 10 patrimonios o instituciones que estén dentro del nuevo rectangulo de coordenadas
            await obtenerPatrimoniosCercanos(nuevaLat1,nuevaLong1,nuevaLat2,nuevaLong2,lat1menor,long1menor).
                then(datos=>{
                    patrimoniosEnRuta=datos.data;
                    numPatrimoniosEnRuta=datos.numPatrimonios;
                    console.log(datos);
                    console.log(patrimoniosEnRuta);
                });
            await enrutamientoConPatrimonios(lat1,long1,lat2,long2);
            anadirPatrimoniosEnRuta();
            await anadirPatrimoniosFueraRuta();
        }
        async function generarRuta() {
            if(controlRuta!=null){
                limpiarMapa();
            }
            let direccionPartida = $("#txtDireccionPartida").val();
            let direccionLlegada = $("#txtDireccionLlegada").val();
            let latLongPartida = await obtenerLatitudLongitudConDireccion(direccionPartida);
            let latLongLlegada = await obtenerLatitudLongitudConDireccion(direccionLlegada);
            let latitudDireccionPartida = latLongPartida[0];
            let longitudDireccionPartida = latLongPartida[1];
            let latitudDireccionLlegada = latLongLlegada[0];
            let longitudDireccionLlegada = latLongLlegada[1];
            console.log(latitudDireccionPartida,longitudDireccionPartida,latitudDireccionLlegada,longitudDireccionLlegada);
            await generarRutaDispersion(latitudDireccionPartida,longitudDireccionPartida,latitudDireccionLlegada,longitudDireccionLlegada);
            let markerInicio = L.marker([latitudDireccionPartida, longitudDireccionPartida], {
                icon: puntoPartidaIcon,
                title: "Partida"
            }).addTo(grupoMarcadoresRuta);
            let markerLlegada = L.marker([latitudDireccionLlegada, longitudDireccionLlegada], {
                icon: puntoLlegadaIcon,
                title: "Llegada"
            }).addTo(grupoMarcadoresRuta);
        }
        function modificarLatitudDispersion(lat,dist){
            let latEnGrados=decimalesAGradosMinutosSegundos(lat);
            let distEnGradosLatitud=dist/LATITUD_METROS;
            let distLatEnGrados=decimalesAGradosMinutosSegundos(distEnGradosLatitud);
            latEnGrados.grados=latEnGrados.grados+distLatEnGrados.grados;
            latEnGrados.minutos=latEnGrados.minutos+distLatEnGrados.minutos;
            latEnGrados.segundos=latEnGrados.segundos+distLatEnGrados.segundos;
            let nuevaLatitud=gradosMinutosSegundosADecimales(latEnGrados.grados,latEnGrados.minutos,latEnGrados.segundos);
            return nuevaLatitud;
        }
        function modificarLongitudDispersion(lat,long,dist){
            let longEnGrados=decimalesAGradosMinutosSegundos(long);
            let distPorGradoLongitud=Math.cos(lat)*LONGITUD_METROS_ECUADOR;
            let distEnGradosLongitud=dist/distPorGradoLongitud;
            let distLongEnGrados=decimalesAGradosMinutosSegundos(distEnGradosLongitud);
            longEnGrados.grados=longEnGrados.grados+distLongEnGrados.grados;
            longEnGrados.minutos=longEnGrados.minutos+distLongEnGrados.minutos;
            longEnGrados.segundos=longEnGrados.segundos+distLongEnGrados.segundos;
            let nuevaLongitud=gradosMinutosSegundosADecimales(longEnGrados.grados,longEnGrados.minutos,longEnGrados.segundos);
            return nuevaLongitud;
        }
        function decimalesAGradosMinutosSegundos(decimales){
            let gradosSexagesimal={
                grados:0,
                minutos:0,
                segundos:0,
            }
            gradosSexagesimal.grados=Math.trunc(decimales);
            decimales=decimales-gradosSexagesimal.grados;
            decimales=decimales*60;
            gradosSexagesimal.minutos=Math.trunc(decimales);
            decimales=decimales-gradosSexagesimal.minutos;
            decimales=decimales*60;
            gradosSexagesimal.segundos=decimales;
            return gradosSexagesimal;
        }
        function gradosMinutosSegundosADecimales(grados,minutos,segundos){
            return (grados+(1/60)*minutos+(1/3600)*segundos);
        }
        function distanciaEntreDosCoordenadas(lat1,long1,lat2,long2){//devuelve en metros
            //mientras más grande la distancia tendrá menos precisión, a más pequeña más precisión
            //en caso de todo el perú son 30m +- de falta de precisión
            let lat1Rad=lat1*(Math.PI/180);
            let lat2Rad=lat2*(Math.PI/180);
            let difLatRad=(lat2-lat1)*(Math.PI/180);
            let difLongRad=(long2-long1)*(Math.PI/180);
            let a=Math.sin(difLatRad/2)*Math.sin(difLatRad/2) +
                Math.cos(lat1Rad)*Math.cos(lat2Rad)*Math.sin(difLongRad/2)*Math.sin(difLongRad/2);
            let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
            let d=RADIO_DE_LA_TIERRA_PROMEDIO_PERU*c*1000;
            return d;
        }
    </script>

{% endblock %}